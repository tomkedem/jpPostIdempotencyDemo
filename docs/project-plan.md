# 📄 תוכנית לפיתוח דמו מתקדם למערכת Idempotency בדואר

## 🎯 מטרת הדמו
המערכת נועדה להדגים בצורה אינטראקטיבית ופשוטה כיצד ניתן למנוע בעיות של כפילויות משלוחים, תקלות רשת וחיובים מיותרים, בעזרת מנגנון מקצועי שנקרא Idempotency.

הדמו יכלול מספר פעולות מרכזיות שמתרחשות בעולם הדואר, כמו:
- שליחת משלוח
- ביטול משלוח
- עדכון סטטוס
- חיפוש פרטי משלוח לפי ברקוד

וכל אחת מהפעולות תעבוד עם מנגנון Idempotency שמונע כפילויות ושומר על עקביות המידע.

## ❗ הבעיה האמיתית בדואר
במציאות, לקוחות ומערכות עלולים לשלוח את אותה בקשה כמה פעמים:
- לחיצה כפולה על כפתור "שלח"
- תקלה זמנית ברשת שגורמת ל־Retry
- לקוח לא בטוח אם הבקשה הצליחה → שולח שוב
- שירותי צד שלישי שמבצעים שליחה אוטומטית מחדש

וזה גורם ל:
- רישום כפול של אותו משלוח
- חיוב כפול
- הדפסת תוויות מיותרות
- בלבול בלוגיסטיקה ותפעול

## ✅ הפתרון: Idempotency חכם
המערכת תדע לזהות ולזכור בקשות שכבר טופלו. אם תגיע בקשה חוזרת:
- עם אותו תוכן בדיוק → נחזיר את אותה תשובה (בלי ליצור שוב)
- עם אותו מזהה אך תוכן שונה → נחסום את הפעולה עם שגיאה 409
- עם תוכן חדש לגמרי → נבצע את הפעולה כרגיל

## 🏗️ תכולת הדמו

### 1. אפליקציית אינטרנט (Angular 20)
- טופס לשליחת משלוח חדש
- טופס לביטול משלוח קיים (ע"י ברקוד)
- טופס לעדכון סטטוס משלוח
- חיפוש משלוח לפי ברקוד
- טבלת ניסיונות פעולה עם סטטוס התגובה (200, 409, וכו')
- עיצוב שמסמן פעולות שבוצעו לעומת כאלה שנחסמו או שוחזרו (Replayed)

### 2. שרת API מתקדם (.NET 8)
- תיעוד OpenAPI (Swagger)
- נקודות קצה: POST /shipments, POST /cancel, POST /status, GET /lookup?barcode=...
- תמיכה ב־Idempotency-Key בכל הפעולות הקריטיות
- לוגים חכמים (structured) עם Correlation-Id
- מנגנון Chaos (לעיכוב/שגיאה יזומים – לדמות רשת בעייתית)

### 3. בסיס נתונים ריאלי (Supabase / PostgreSQL)
טבלאות:
- **Shipments** – משלוחים
- **IdempotencyEntries** – מזהים שטופלו
- שמירת התוצאה של כל פעולה לפי המפתח שלה
- חישוב חתימה על הבקשה (SHA256 של התוכן) למניעת שגיאות

## 🔐 איך מחושב Idempotency-Key?
בצד הלקוח, נחשב מפתח לפי תוכן הבקשה (ברקוד, יעד, פעולה וכו')
נשמיט שדות "רועשים" כמו תאריך שליחה או שדות שמתעדכנים אוטומטית
התוצאה: כל בקשה זהה תניב מפתח זהה

**דוגמה:**
```json
{
  "barcode": "RR63457568548"  
}
```
→ יניב hash שישמש כ־Idempotency-Key

## 🧪 דוגמה לתרחיש בפועל:
1. המשתמש ממלא טופס שליחה של משלוח
2. האפליקציה מחשבת את המזהה
3. נשלחת בקשה לשרת
4. השרת יוצר משלוח ושומר את התוצאה
5. אם תישלח בקשה חוזרת:
   - עם אותו תוכן → תוחזר אותה תשובה (Replayed)
   - עם תוכן שונה → תחסם (Conflict)

ניתן לבדוק זאת דרך הדמו: שליחה של 3 ניסיונות ברצף

## 💰 ערך ממשי לדואר

| תחום | מה זה נותן |
|------|------------|
| כספי | אין חיוב כפול / משלוחים מיותרים |
| תפעולי | לא מודפסות תוויות מיותרות |
| שירות | אין פניות "שלחתי ולא קיבלתי אישור" |
| טכנולוגי | בסיס לארכיטקטורה יציבה וסטנדרט עולמי |

## 📦 מה הדמו כולל
- ממשק ויזואלי להדגמה
- לוגים מפורטים
- תסריטים חוזרים (retries)
- שליטה ב־Chaos (לבדוק איך המערכת מתנהגת תחת לחץ)
- קוד פתוח לשימוש/שדרוג פנימי
