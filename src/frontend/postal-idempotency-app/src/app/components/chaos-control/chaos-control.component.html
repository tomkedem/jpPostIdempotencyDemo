<div class="control-screen-container" dir="rtl">
  <!-- Main Header -->
  <header class="main-header">
    <div class="title-container">
      <mat-icon class="header-icon">security</mat-icon>
      <h1>הגנת אידמפוטנטיות</h1>
      <p class="subtitle">מניעת כפילויות בפעולות קריטיות</p>
    </div>
    <div class="status-container">
      <div
        class="system-status-indicator"
        [ngClass]="
          idempotencyProtectionEnabled() ? 'status-active' : 'status-inactive'
        "
      >
        <div class="status-light"></div>
        <span>{{
          idempotencyProtectionEnabled() ? "הגנה פעילה" : "הגנה כבויה"
        }}</span>
      </div>
      <!-- הוספת אינדיקטור בריאות מערכת -->
      <div class="system-health" [ngClass]="getSystemHealthClass()">
        <mat-icon>{{ getSystemHealthIcon() }}</mat-icon>
        <span>{{ getSystemHealthText() }}</span>
      </div>
      <div class="current-time">
        {{ currentTime() | date : "HH:mm:ss" }}
      </div>
    </div>
  </header>

  <!-- Main Content Grid -->
  <main class="main-grid">
    <!-- Left Column -->
    <div class="grid-column column-left">
      <!-- Control Panel -->
      <div class="panel control-panel">
        <div class="panel-header">
          <mat-icon>toggle_on</mat-icon>
          <h2>בקרה וניהול</h2>
        </div>
        <div class="panel-content">
          <div class="control-row">
            <label for="idempotency-toggle">הגנת אידמפוטנטיות</label>
            <mat-slide-toggle
              id="idempotency-toggle"
              [checked]="idempotencyProtectionEnabled()"
              (change)="toggleIdempotencyProtection()"
              color="primary"
            ></mat-slide-toggle>
          </div>
          <div class="control-row">
            <label for="expiration-input">תפוגת מפתח (שעות)</label>
            <input
              id="expiration-input"
              type="number"
              [value]="expirationHours()"
              (input)="updateExpirationHours(+$any($event.target).value)"
              min="1"
              max="168"
            />
          </div>
        </div>
      </div>

      <!-- Demo Guide -->
      <div class="panel guide-panel">
        <div class="panel-header">
          <mat-icon>integration_instructions</mat-icon>
          <h2>מדריך הדגמה</h2>
        </div>
        <div class="panel-content">
          <!-- Real-time Performance Chart - Compact Version -->
          <div class="performance-chart-compact">
            <div class="chart-header-compact">
              <h4>מגמות ביצועים</h4>
              <div class="chart-legend-compact">
                <span class="legend-dot success"></span>
                <span class="legend-dot blocked"></span>
              </div>
            </div>
            <div class="chart-container-compact">
              <canvas #performanceChart width="300" height="80"></canvas>
            </div>
          </div>

          <ol class="guide-steps">
            <li class="step">
              <div class="step-number">1</div>
              <div class="step-content">
                <strong>יצירת מפתח:</strong>
                <span
                  >צור מפתח דטרמיניסטי מ-<code>barcode</code>
                  ו-<code>statusId</code>.</span
                >
              </div>
            </li>
            <li class="step">
              <div class="step-number">2</div>
              <div class="step-content">
                <strong>שליחת בקשה:</strong>
                <span>שלח את המפתח בכותרת <code>Idempotency-Key</code>.</span>
              </div>
            </li>
            <li class="step">
              <div class="step-number">3</div>
              <div class="step-content">
                <strong>קבלת תגובה:</strong>
                <span>השרת ישמור את התוצאה וימנע כפילות.</span>
              </div>
            </li>
            <li class="step">
              <div class="step-number">4</div>
              <div class="step-content">
                <strong>מעקב וניטור:</strong>
                <span>עקוב אחר התוצאות במדדים ובלוג המערכת.</span>
              </div>
            </li>
          </ol>
        </div>
      </div>

      <!-- Real-time Performance Chart -->
      <!-- <div class="performance-chart">
        <div class="chart-header">
          <h3>מגמות ביצועים (דקות אחרונות)</h3>
          <div class="chart-legend">
            <span class="legend-item success">
              <div class="legend-color success"></div>
              <strong class="green-text">ירוק:</strong> בקשות שעובדו בהצלחה
            </span>
            <span class="legend-item blocked">
              <div class="legend-color blocked"></div>
              <strong class="red-text">אדום:</strong> בקשות שנחסמו (כפולות)
            </span>
          </div>
        </div>
        <div class="chart-container">
          <canvas #performanceChart width="400" height="150"></canvas>
        </div>
      </div> -->
    </div>

    <!-- Right Column -->
    <div class="grid-column column-right">
      <!-- Metrics Panel -->
      <div class="panel metrics-panel">
        <div class="panel-header">
          <mat-icon>insights</mat-icon>
          <h2>מדדי הגנת אידמפוטנטיות</h2>
          <div class="panel-actions">
            <button
              mat-icon-button
              (click)="resetMetrics()"
              title="איפוס מדדים"
            >
              <mat-icon>refresh</mat-icon>
            </button>
            <button mat-icon-button (click)="exportMetrics()" title="ייצוא דוח">
              <mat-icon>download</mat-icon>
            </button>
          </div>
        </div>
        <div class="panel-content">
          <!-- Real-time Update Status -->
          <div class="update-status-panel">
            <div class="update-indicator">
              <div class="indicator-dot active"></div>
              <span class="status-text">עדכון אוטומטי פעיל</span>
            </div>
            <div class="update-info">
              <mat-icon>info</mat-icon>
              <span>המדדים מתעדכנים אוטומטיקלית כל 5 שניות מהשרת</span>
            </div>
          </div>

          <!-- Quick Stats Summary -->
          <div class="quick-stats">
            <div class="stat-item">
              <div class="stat-icon">
                <mat-icon>speed</mat-icon>
              </div>
              <div class="stat-content">
                <div class="stat-value">
                  {{ metrics()?.averageResponseTime || 0 | number : "1.0-0" }}ms
                </div>
                <div class="stat-label">זמן תגובה ממוצע</div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">
                <mat-icon>trending_up</mat-icon>
              </div>
              <div class="stat-content">
                <div class="stat-value">
                  {{ metrics()?.successRate || 0 | number : "1.0-1" }}%
                </div>
                <div class="stat-label">אחוז הצלחה</div>
              </div>
            </div>
          </div>

          <div class="metrics-grid">
            <div class="metric-card total-operations">
              <div class="metric-content">
                <div class="metric-value">
                  {{ metrics()?.totalOperations || 0 | number }}
                </div>
                <div class="metric-label">סה"כ פעולות</div>
                <div class="metric-progress">
                  <div class="progress-bar total"></div>
                </div>
              </div>
              <mat-icon class="metric-icon">bar_chart</mat-icon>
            </div>

            <div class="metric-card blocked-operations">
              <div class="metric-content">
                <div class="metric-value">
                  {{ metrics()?.idempotentBlocks || 0 | number }}
                </div>
                <div class="metric-label">חסימות אידמפוטנט</div>
                <div class="metric-progress">
                  <div
                    class="progress-bar blocked"
                    [style.width.%]="getBlockedPercentage()"
                  ></div>
                </div>
              </div>
              <mat-icon class="metric-icon">security</mat-icon>
            </div>

            <div class="metric-card successful-operations">
              <div class="metric-content">
                <div class="metric-value">
                  {{ metrics()?.successfulOperations || 0 | number }}
                </div>
                <div class="metric-label">פעולות מוצלחות</div>
                <div class="metric-progress">
                  <div
                    class="progress-bar successful"
                    [style.width.%]="getSuccessPercentage()"
                  ></div>
                </div>
              </div>
              <mat-icon class="metric-icon">check_circle</mat-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- Terminal Panel -->
      <div class="panel terminal-panel">
        <div class="panel-content">
          <div class="terminal-content">
            <div class="terminal-header">
              <span class="terminal-title">לוג הגנת אידמפוטנטיות</span>
              <button
                mat-icon-button
                (click)="clearLogs()"
                class="clear-logs-btn"
                title="נקה לוג"
              >
                <mat-icon>clear_all</mat-icon>
              </button>
            </div>
            <div class="terminal-logs">
              @for (log of getRecentLogs(); track log.timestamp) {
              <div class="log-entry" [class]="log.level">
                <span class="log-timestamp">{{
                  log.timestamp | date : "HH:mm:ss"
                }}</span>
                <span class="log-level">[{{ log.level.toUpperCase() }}]</span>
                <span class="log-message">{{ log.message }}</span>
              </div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
