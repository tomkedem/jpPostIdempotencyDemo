<div class="control-screen-container" dir="rtl">
  <!-- Main Header -->
  <header class="main-header">
    <div class="title-container">
      <mat-icon class="header-icon">security</mat-icon>
      <h1>הגנת אידמפוטנטיות</h1>
      <p class="subtitle">מניעת כפילויות בפעולות קריטיות</p>
    </div>
    <div class="status-container">
      <div
        class="system-status-indicator"
        [ngClass]="
          chaosService.settings().useIdempotencyKey
            ? 'status-active'
            : 'status-inactive'
        "
      >
        <div class="status-light"></div>
        <span>{{
          chaosService.settings().useIdempotencyKey
            ? "הגנה פעילה"
            : "הגנה כבויה"
        }}</span>
      </div>
      <div class="current-time">
        {{ currentTime() | date : "HH:mm:ss" }}
      </div>
    </div>
  </header>

  <!-- Main Content Grid -->
  <main class="main-grid">
    <!-- Left Column -->
    <div class="grid-column column-left">
      <!-- Control Panel -->
      <div class="panel control-panel">
        <div class="panel-header">
          <mat-icon>toggle_on</mat-icon>
          <h2>בקרה וניהול</h2>
        </div>
        <div class="panel-content">
          <div class="control-row">
            <label for="idempotency-toggle">הגנת אידמפוטנטיות</label>
            <mat-slide-toggle
              id="idempotency-toggle"
              [checked]="idempotencyProtectionEnabled()"
              (change)="toggleIdempotencyProtection()"
              color="primary"
            ></mat-slide-toggle>
          </div>
          <div class="control-row">
            <label for="expiration-input">תפוגת מפתח (שעות)</label>
            <input
              id="expiration-input"
              type="number"
              [value]="expirationHours()"
              (input)="updateExpirationHours(+$any($event.target).value)"
              min="1"
              max="168"
            />
          </div>
        </div>
      </div>

      <!-- Demo Guide -->
      <div class="panel guide-panel">
        <div class="panel-header">
          <mat-icon>integration_instructions</mat-icon>
          <h2>מדריך הדגמה</h2>
        </div>
        <div class="panel-content">
          <ol class="guide-steps">
            <li class="step">
              <div class="step-number">1</div>
              <div class="step-content">
                <strong>יצירת מפתח:</strong>
                <span
                  >צור מפתח דטרמיניסטי מ-<code>barcode</code>
                  ו-<code>statusId</code>.</span
                >
              </div>
            </li>
            <li class="step">
              <div class="step-number">2</div>
              <div class="step-content">
                <strong>שליחת בקשה:</strong>
                <span>שלח את המפתח בכותרת <code>Idempotency-Key</code>.</span>
              </div>
            </li>
            <li class="step">
              <div class="step-number">3</div>
              <div class="step-content">
                <strong>עיבוד בשרת:</strong>
                <span>השרת ישמור את התוצאה וימנע כפילות.</span>
              </div>
            </li>
            <li class="step">
              <div class="step-number">4</div>
              <div class="step-content">
                <strong>מעקב וניטור:</strong>
                <span>עקוב אחר התוצאות במדדים ובלוג המערכת.</span>
              </div>
            </li>
          </ol>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="grid-column column-right">
      <!-- Metrics Panel -->
      <div class="panel metrics-panel">
        <div class="panel-header">
          <mat-icon>insights</mat-icon>
          <h2>מדדי הגנת אידמפוטנטיות</h2>
        </div>
        <div class="panel-content">
          <div class="metrics-grid">
            <div class="metric-card main-metric">
              <div class="metric-value">
                {{ metrics()?.successRate || 0 | number : "1.0-2"
                }}<span class="metric-unit">%</span>
              </div>
              <div class="metric-label">אחוז הצלחה</div>
              <mat-icon class="metric-icon">verified_user</mat-icon>
            </div>
            <div class="metric-card">
              <div class="metric-value">
                {{ metrics()?.totalOperations || 0 | number }}
              </div>
              <div class="metric-label">סה"כ פעולות</div>
              <mat-icon class="metric-icon">sync_alt</mat-icon>
            </div>
            <div class="metric-card">
              <div class="metric-value">
                {{ metrics()?.idempotentBlocks || 0 | number }}
              </div>
              <div class="metric-label">חסימות אידמפוטנט</div>
              <mat-icon class="metric-icon">gpp_good</mat-icon>
            </div>
            <div class="metric-card">
              <div class="metric-value">
                {{ metrics()?.successfulOperations || 0 | number }}
              </div>
              <div class="metric-label">פעולות מוצלחות</div>
              <mat-icon class="metric-icon">task_alt</mat-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Log Terminal -->
      <div class="panel terminal-panel">
        <div class="panel-header">
          <mat-icon>terminal</mat-icon>
          <h2>לוג הגנת אידמפוטנטיות</h2>
          <div class="terminal-controls">
            <div class="control-dot red"></div>
            <div class="control-dot yellow"></div>
            <div class="control-dot green"></div>
          </div>
        </div>
        <div class="panel-content terminal-content" #terminalContent>
          @for (log of logHistory(); track log.timestamp) {
          <div class="log-line" [ngClass]="log.level">
            <span class="log-timestamp"
              >[{{ log.timestamp | date : "HH:mm:ss.SSS" }}]</span
            >
            <span class="log-level">[{{ log.level.toUpperCase() }}]</span>
            <span class="log-message">{{ log.message }}</span>
          </div>
          } @empty {
          <div class="log-line info">
            <span class="log-timestamp"
              >[{{ currentTime() | date : "HH:mm:ss.SSS" }}]</span
            >
            <span class="log-level">[INFO]</span>
            <span class="log-message">ממתין לפעילות...</span>
          </div>
          }
        </div>
      </div>
    </div>
  </main>
</div>
