<div class="control-screen-container" dir="rtl">
  <!-- Main Header -->
  <header class="main-header">
    <div class="title-container">
      <mat-icon class="header-icon">security</mat-icon>
      <div class="title-text-container">
        <h1>הגנת אידמפוטנטיות</h1>
        <p class="subtitle">מניעת כפילויות בפעולות קריטיות</p>
      </div>
    </div>
    <div class="status-container">
      <div
        class="system-status-indicator"
        [ngClass]="
          idempotencyProtectionEnabled() ? 'status-active' : 'status-inactive'
        "
      >
        <div class="status-light"></div>
        <span>{{
          idempotencyProtectionEnabled() ? "הגנה פעילה" : "הגנה כבויה"
        }}</span>
      </div>
      
      <!-- Compact Premium Controls Section -->
      <div class="premium-controls-compact">
        <!-- Main Simulation Control - Inline -->
        <div class="control-group-inline">
          <button 
            mat-fab 
            extended
            class="premium-simulation-btn-compact"
            (click)="startRandomSimulation()"
            [class.simulation-running]="isSimulationRunning()"
            [class.simulation-ready]="!isSimulationRunning()">
            <mat-icon class="btn-icon">{{ isSimulationRunning() ? 'stop_circle' : 'play_circle' }}</mat-icon>
            <span class="btn-text">{{ isSimulationRunning() ? 'עצור' : 'הפעל דמוי' }}</span>
            <div class="btn-glow-effect"></div>
          </button>
          
          <!-- Debug Button - Smaller -->
          <button 
            mat-mini-fab 
            class="premium-debug-btn-compact"
            color="accent"
            (click)="debugBarcodeState()"
            matTooltip="בדיקת מצב ברקוד פעיל במערכת"
            matTooltipPosition="below">
            <mat-icon>developer_mode</mat-icon>
          </button>
          
          <!-- System Health Indicator - Compact -->
          <div class="premium-health-indicator-compact" [ngClass]="getSystemHealthClass()">
            <div class="health-pulse"></div>
            <mat-icon class="health-icon">{{ getSystemHealthIcon() }}</mat-icon>
            <div class="health-details-compact">
              <span class="health-label">{{ getSystemHealthText() }}</span>
              <span class="health-metric">{{ metrics()?.successRate || 0 | number:'1.0-1' }}%</span>
            </div>
          </div>
          
          <!-- Enhanced Time Display - Compact -->
          <div class="premium-time-display-compact">
            <div class="time-background"></div>
            <mat-icon class="time-icon">schedule</mat-icon>
            <span class="time-value">{{ currentTime() | date : "HH:mm:ss" }}</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Compact Progress Indicator -->
  <div class="premium-simulation-progress-compact" *ngIf="isSimulationRunning()">
    <div class="progress-container-compact">
      <div class="progress-header-compact">
        <div class="progress-info-compact">
          <span class="progress-title-compact">סימולציה פעילה</span>
          <span class="progress-stats-compact">{{ currentClickCount() }}/400</span>
        </div>
        <div class="progress-percentage-compact">{{ simulationProgress() | number:'1.0-0' }}%</div>
        <div class="eta-display-compact">
          <mat-icon>timer</mat-icon>
          <span>{{ (400 - currentClickCount()) * 0.05 | number:'1.0-0' }}s</span>
        </div>
      </div>
      
      <div class="progress-bar-container-compact">
        <mat-progress-bar 
          mode="determinate" 
          [value]="simulationProgress()"
          class="premium-progress-bar-compact">
        </mat-progress-bar>
        <div class="progress-glow-compact" [style.width.%]="simulationProgress()"></div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <main class="main-grid">
    <!-- Left Column -->
    <div class="grid-column column-left">
      <!-- Control Panel -->
      <div class="panel control-panel">
        <div class="panel-header">
          <mat-icon>toggle_on</mat-icon>
          <h2>בקרה וניהול</h2>
        </div>
        <div class="panel-content">
          <div class="control-row">
            <label for="idempotency-toggle">הגנת אידמפוטנטיות</label>
            <mat-slide-toggle
              id="idempotency-toggle"
              [checked]="idempotencyProtectionEnabled()"
              (change)="toggleIdempotencyProtection()"
              color="primary"
            ></mat-slide-toggle>
          </div>
          <div class="control-row">
            <label for="expiration-input">תפוגת מפתח (שעות)</label>
            <input
              id="expiration-input"
              type="number"
              [value]="expirationHours()"
              (input)="updateExpirationHours(+$any($event.target).value)"
              min="1"
              max="168"
            />
          </div>
        </div>
      </div>

      <!-- Demo Guide -->
      <div class="panel guide-panel">
        <div class="panel-header">
          <mat-icon>integration_instructions</mat-icon>
          <h2>מדריך הדגמה</h2>
        </div>
        <div class="panel-content">
          <!-- Real-time Performance Chart - Compact Version -->
          <div class="performance-chart-compact">
            <div class="chart-header-compact">
              <h4>מגמות ביצועים</h4>
              <div class="chart-legend-compact">
                <span class="legend-dot success"></span>
                <span class="legend-dot blocked"></span>
                <span class="legend-dot chaos-errors"></span>
              </div>
            </div>
            <div class="chart-container-compact">
              <canvas #performanceChart width="300" height="80"></canvas>
            </div>
          </div>

          <ol class="guide-steps">
            <li class="step">
              <div class="step-number">1</div>
              <div class="step-content">
                <strong>יצירת מפתח:</strong>
                <span
                  >צור מפתח דטרמיניסטי מ-<code>barcode</code>
                  ו-<code>statusId</code>.</span
                >
              </div>
            </li>
            <li class="step">
              <div class="step-number">2</div>
              <div class="step-content">
                <strong>שליחת בקשה:</strong>
                <span>שלח את המפתח בכותרת <code>Idempotency-Key</code>.</span>
              </div>
            </li>
            <li class="step">
              <div class="step-number">3</div>
              <div class="step-content">
                <strong>קבלת תגובה:</strong>
                <span>השרת ישמור את התוצאה וימנע כפילות.</span>
              </div>
            </li>
            <li class="step">
              <div class="step-number">4</div>
              <div class="step-content">
                <strong>מעקב וניטור:</strong>
                <span>עקוב אחר התוצאות במדדים ובלוג המערכת.</span>
              </div>
            </li>
          </ol>
        </div>
      </div>      
    </div>

    <!-- Right Column -->
    <div class="grid-column column-right">
      <!-- Metrics Panel -->
      <div class="panel metrics-panel">
        <div class="panel-header">
          <mat-icon>insights</mat-icon>
          <h2>מדדי הגנת אידמפוטנטיות</h2>
          <div class="panel-actions">
            <button
              mat-icon-button
              (click)="resetMetrics()"
              title="איפוס מדדים"
            >
              <mat-icon>refresh</mat-icon>
            </button>
            <button mat-icon-button (click)="exportMetrics()" title="ייצוא דוח">
              <mat-icon>download</mat-icon>
            </button>
          </div>
          <div class="update-status-panel">
            <div class="update-indicator">
              <div class="indicator-dot active"></div>
              <span class="status-text">עדכון אוטומטי פעיל</span>
            </div>
          </div>
        </div>
        <div class="metrics-info-section">
          <div class="update-info">
            <mat-icon>info</mat-icon>
            <span>המדדים מתעדכנים אוטומטיקלית כל 5 שניות מהשרת</span>
          </div>
        </div>
        <div class="panel-content">
          <!-- Real-time Update Status -->
          

          <!-- Quick Stats Summary -->
          <div class="quick-stats">
            <div class="stat-item">
              <div class="stat-icon">
                <mat-icon>speed</mat-icon>
              </div>
              <div class="stat-content">
                <div class="stat-value">
                  {{ metrics()?.averageExecutionTimeMs || 0 | number : "1.0-0" }}ms
                </div>
                <div class="stat-label">זמן תגובה ממוצע</div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">
                <mat-icon>trending_up</mat-icon>
              </div>
              <div class="stat-content">
                <div class="stat-value">
                  {{ metrics()?.successRate || 0 | number : "1.0-1" }}%
                </div>
                <div class="stat-label">אחוז הצלחה</div>
              </div>
            </div>
            <div class="stat-item time-saved">
              <div class="stat-icon">
                <mat-icon>hourglass_empty</mat-icon>
              </div>
              <div class="stat-content">
                <div class="stat-value">
                  {{ getTimeSavedFormatted() }}
                </div>
                <div class="stat-precise" *ngIf="getTimeSavedMs() >= 1000">
                  {{ getTimeSavedMs() | number : "1.0-0" }}ms
                </div>
                <div class="stat-label">זמן שנחסך</div>
              </div>
            </div>
          </div>

          <div class="metrics-grid">
            <div class="metric-card successful-operations">
              <div class="metric-content">
                <div class="metric-value">
                  {{ metrics()?.successfulOperations || 0 | number }}
                </div>
                <div class="metric-label">פעולות שעודכנו</div>
                <div class="metric-progress">
                  <div
                    class="progress-bar successful"
                    [style.width.%]="getSuccessPercentage()"
                  ></div>
                </div>
              </div>
              <mat-icon class="metric-icon">check_circle</mat-icon>
            </div>

            <div class="metric-card blocked-operations">
              <div class="metric-content">
                <div class="metric-value">
                  {{ metrics()?.idempotentHits || 0 | number }}
                </div>
                <div class="metric-label">חסימות אידמפוטנט</div>
                <div class="metric-progress">
                  <div
                    class="progress-bar blocked"
                    [style.width.%]="getBlockedPercentage()"
                  ></div>
                </div>
              </div>
              <mat-icon class="metric-icon">security</mat-icon>
            </div>
            <div class="metric-card total-operations">
              <div class="metric-content">
                <div class="metric-value">
                  {{ metrics()?.totalOperations || 0 | number }}
                </div>
                <div class="metric-label">סה"כ פעולות</div>
                <div class="metric-progress">
                  <div class="progress-bar total"></div>
                </div>
              </div>
              <mat-icon class="metric-icon">bar_chart</mat-icon>
            </div>
            

            <!-- NEW: Chaos Disabled Errors Card -->
            <div class="metric-card chaos-errors">
              <div class="metric-content">
                <div class="metric-value">
                  {{ getChaosErrorsCount() | number }}
                </div>
                <div class="metric-label">שגיאות בלי הגנה</div>
                <div class="metric-progress">
                  <div
                    class="progress-bar chaos-errors"
                    [style.width.%]="getChaosErrorsPercentage()"
                  ></div>
                </div>
              </div>
              <mat-icon class="metric-icon">warning</mat-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- Terminal Panel -->
      <div class="panel terminal-panel">
        <div class="panel-content">
          <div class="terminal-content">
            <div class="terminal-header">
              <span class="terminal-title">לוג הגנת אידמפוטנטיות</span>
              <button
                mat-icon-button
                (click)="clearLogs()"
                class="clear-logs-btn"
                title="נקה לוג"
              >
                <mat-icon>clear_all</mat-icon>
              </button>
            </div>
            <div class="terminal-logs">
              @for (log of getRecentLogs(); track log.timestamp) {
              <div class="log-entry" [class]="log.level">
                <span class="log-timestamp">{{
                  log.timestamp | date : "HH:mm:ss"
                }}</span>
                <span class="log-level">[{{ log.level.toUpperCase() }}]</span>
                <span class="log-message">{{ log.message }}</span>
              </div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
